#!/usr/bin/env python
# -*- coding: utf-8 -*-

import os
import sys
import zipfile


for zip_file in sys.argv[1:]:
    print "Processing File {}".format(zip_file)
    if not zip_file.endswith(".zip"):
        continue
    try:
        file = zipfile.ZipFile(zip_file, "r")
        selected_coding = None
        for coding in ['utf8', 'gbk', 'gb2312', 'big5', 'cp932', 'iso2022_jp', 'euc_jp', 'shift_jis']:
            failed = False
            for name in file.namelist():
                try:
                    name.decode(coding)
                except UnicodeDecodeError:
                    failed = True
                    break
            if not failed:
                selected_coding = coding

        if selected_coding is None:
            print "Cannot find a valid coding for {}. Skipped".format(zip_file)
            continue
        print "Use coding {}".format(selected_coding)

        zip_file = os.path.basename(zip_file)[:-4]
        for name in file.namelist():
            utf8name = os.path.join(zip_file, name.decode(selected_coding))

            print "Extracting " + utf8name
            pathname = os.path.dirname(utf8name)
            if not os.path.exists(pathname) and pathname != "":
                os.makedirs(pathname)
            data = file.read(name)
            if not os.path.exists(utf8name):
                fo = open(utf8name, "w")
                fo.write(data)
                fo.close
        file.close()
    except zipfile.BadZipfile:
        print "Failed unzipping %s" % zip_file
